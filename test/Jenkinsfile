pipeline {
    agent any
    options {
        skipDefaultCheckout()
        disableConcurrentBuilds()
        timeout(time: 20, unit: 'MINUTES')
    }
    stages {
        stage("Set Repository") {
            when {
                not {
                    expression {
                        return env.GIT_REPO
                    }
                }
            }
            steps {
                script {
                    env.GIT_REPO = input(id: 'repository',
                                         message: 'Select repository',
                                         parameters: [string(defaultValue: '', name: 'Repository')]);
                }
            }
        }
        stage("Set Branch") {
            when {
                not {
                    expression {
                        return env.GIT_BRANCH
                    }
                }         
            }
            steps {
                script {
                    env.GIT_BRANCH = input(id: 'branch',
                                           message: 'Select branch',
                                           parameters: [string(defaultValue: '', name: 'Branch')]);
                }
            }
        }
        stage("Checkout Code") {
            steps {
                script {
                    git branch: env.GIT_BRANCH, url: env.GIT_REPO
                }
            }
        }
        stage("Initialize") {
            steps {
                script {
                    if (!env.IMAGE_NAME) 
                        env.IMAGE_NAME = env.APP_NAME;    
                }
            }
        }
        stage ("Apply Changes") {
            when {
                expression {
                    return env.APP_TEMPLATE
                }
            }
            steps {
                script {
                    openshift.withCluster() {
                        openshift.withProject() {
                            openshift.apply(openshift.process(readFile(file: env.APP_TEMPLATE), "-p", "PARAM_APP_NAME=${env.APP_NAME}"));
                        }
                    }
                }
            }
        }
        stage("Set Project") {
            when {
                not {
                    expression {
                        return env.PROJECT
                    }
                }
            }
            steps {
                script {
                     env.PROJECT = input(id: 'project',
                                         message: 'Select the project where the tag to deploy resides',
                                         parameters: [string(defaultValue: '', name: 'Project')]);
                }
            }
        }
        stage("Select Tag") {
            when {
                not {
                    expression {
                        return env.TAG
                    }
                }
            }
            steps {
                script {
                    openshift.withCluster() {
                        openshift.withProject("${env.PROJECT}") {
                            def is = openshift.selector("is", "hello-service").object();
                            def tags = "";
                            
                            for (tag in is.spec.tags)
                                tags = tag.name + "\n" + tags; 
                            
                            env.TAG = input(message: "Select version",
                                            parameters: [choice(choices: tags, description: '', name: 'Versions')]);
                        }
                    }
                }
            }
        }
        stage("Deploy Application") {
            steps {
                script {
                    openshift.withCluster() {
                        openshift.withProject() {
                            openshift.set("triggers", "dc/${env.APP_NAME}", "--from-image=${env.IMAGE_NAME}:${env.TAG}", "-c ${env.APP_NAME}");
                        } 
                    }
                }
            }
        }
        /*
        stage("Integration Test") {
            steps {
                script {

                }
            }
        }
        */
    }
}