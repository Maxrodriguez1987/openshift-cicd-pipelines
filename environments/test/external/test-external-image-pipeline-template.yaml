apiVersion: v1
kind: Template
metadata:
  name: test-external-image-pipeline-template
  annotations:
    openshift.io/display-name: Application Pipeline (Test - External Image)
    iconClass: fa fa-code
    description: Template to generate a external image testing pipeline
objects:
- apiVersion: v1
  kind: BuildConfig
  metadata:
    labels:
      app: ${PARAM_APP_NAME}
    name: ${PARAM_APP_NAME}-pipeline
  spec:
    source:
      type: Git
      git:
        uri: https://github.com/redhatcsargentina/openshift-pipelines.git
        ref: master
      contextDir: environments/test/external
    strategy:
      jenkinsPipelineStrategy:
        env:
        - name: APP_NAME
          value: ${PARAM_APP_NAME}
        - name: APP_TEMPLATE_FILE
          value: ${PARAM_APP_TEMPLATE_FILE}
        - name: SRC_REGISTRY_TOKEN
          value: ${PARAM_SRC_REGISTRY_TOKEN}
        - name: DST_PROJECT_NAME
          value: test
        - name: DST_REGISTRY_URL
          value: ${PARAM_DST_REGISTRY_URL}
        - name: DST_REGISTRY_TOKEN
          value: ${PARAM_DST_REGISTRY_TOKEN}
        - name: GIT_REPO
          value: ${PARAM_GIT_REPO}
        - name: GIT_BRANCH
          value: ${PARAM_GIT_BRANCH}
        - name: GIT_SECRET
          value: ${PARAM_GIT_SECRET}
        - name: APPROVAL_GROUP
          value: test-approvers
        jenkinsfilePath: Jenkinsfile
      type: JenkinsPipeline
    triggers:
      - generic:
          allowEnv: true
          secret: ${PARAM_WEBHOOK_SECRET}
        type: Generic
parameters:
- description: The name for the application to deploy 
  displayName: Application Name
  name: PARAM_APP_NAME
  required: true
- description: The application template file (YAML) to create the application objects
  displayName: Application Template File
  name: PARAM_APP_TEMPLATE_FILE
  required: true
- description: The application Git repository
  displayName: Git Repository
  name: PARAM_GIT_REPO
  required: true
- description: The application branch for development
  displayName: Git Branch
  name: PARAM_GIT_BRANCH
  required: true
- description: The Git credentials (must be the name of an OpenShift Secret or "none" if credentials are not needed)
  displayName: Git Credentials
  name: PARAM_GIT_SECRET
  required: true
- description: The source registry token (if the registry is public, the value is none)
  displayName: Source Registry Token
  name: PARAM_SRC_REGISTRY_TOKEN
  required: false
  value: none
- description: The destination registry URL
  displayName: Destination Registry URL
  name: PARAM_DST_REGISTRY_URL
  required: true
- description: The destination registry token
  displayName: Destination Registry Token
  name: PARAM_DST_REGISTRY_TOKEN
  required: true
- description: A secret string used to configure the webhook
  displayName: Webhook Secret
  name: PARAM_WEBHOOK_SECRET
  generate: expression 
  from: "[a-zA-Z0-9]{40}"